name: "Check Workflow"

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run lint

  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm test

  verify-dist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run build
      - name: Check dist is up to date
        run: |
          if [ -n "$(git diff --name-only dist/)" ]; then
            echo "::error::dist/index.js is out of date. Run 'npm run build' and commit the result."
            git diff --stat dist/
            exit 1
          fi

  test-action:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - job-id:     since-v520
            name:       "Since v5.20"
            since-perl: "v5.20"
            expected:   '["5.20","5.22","5.24","5.26","5.28","5.30","5.32","5.34","5.36","5.38","5.40","5.42"]'

          - job-id:     since-520
            name:       "Since 5.20"
            since-perl: "5.20"
            expected:   '["5.20","5.22","5.24","5.26","5.28","5.30","5.32","5.34","5.36","5.38","5.40","5.42"]'

          - job-id:     since-536-with-devel
            name:       "Since 5.36 with devel"
            since-perl: "5.36"
            with-devel: "true"
            expected:   '["5.36","5.38","5.40","5.42","devel"]'

          - job-id:     since-524-to-532
            name:       "Since 5.24 until 5.32"
            since-perl: "5.24"
            until-perl: "5.32"
            expected:   '["5.24","5.26","5.28","5.30","5.32"]'

          - job-id:     with-devel-and-until
            name:       "With devel and until-perl"
            since-perl: "5.36"
            until-perl: "5.40"
            with-devel: "true"
            expected:   '["5.36","5.38","5.40","devel"]'

          - job-id:     single-version
            name:       "Single version"
            since-perl: "5.32"
            until-perl: "5.32"
            expected:   '["5.32"]'

          - job-id:     oldest-supported
            name:       "Oldest supported version is 5.8"
            since-perl: "5.6"
            until-perl: "5.14"
            expected:   '["5.8","5.10","5.12","5.14"]'

          - job-id:     patch-version-input
            name:       "Patch version 5.8.1 includes 5.8 series"
            since-perl: "5.8.1"
            until-perl: "5.14"
            expected:   '["5.8","5.10","5.12","5.14"]'

          - job-id:     single-out-newest
            name:       "Single out newest"
            since-perl: "5.36"
            until-perl: "5.42"
            single-out: "newest"
            expected:   '["5.36","5.38","5.40"]'
            expected-single-out: "5.42"

          - job-id:     single-out-oldest
            name:       "Single out oldest"
            since-perl: "5.36"
            until-perl: "5.40"
            single-out: "oldest"
            expected:   '["5.38","5.40"]'
            expected-single-out: "5.36"

          - job-id:     single-out-devel
            name:       "Single out devel"
            since-perl: "5.38"
            until-perl: "5.42"
            with-devel: "true"
            single-out: "devel"
            expected:   '["5.38","5.40","5.42"]'
            expected-single-out: "devel"

          - job-id:     single-out-exact
            name:       "Single out exact version"
            since-perl: "5.34"
            until-perl: "5.40"
            single-out: "5.36"
            expected:   '["5.34","5.38","5.40"]'
            expected-single-out: "5.36"

          - job-id:     single-out-out-of-range
            name:       "Single out version not in range"
            since-perl: "5.36"
            until-perl: "5.40"
            single-out: "5.20"
            expected:   '["5.36","5.38","5.40"]'
            expected-single-out: "5.20"

          - job-id:     single-out-latest
            name:       "Single out latest"
            since-perl: "5.36"
            until-perl: "5.42"
            single-out: "latest"
            expected:   '["5.36","5.38","5.40"]'
            expected-single-out: "5.42"

    steps:
      - uses: actions/checkout@v4

      - name: "Call action - ${{ matrix.name }}"
        id: call-action
        uses: ./
        with:
          since-perl: ${{ matrix.since-perl }}
          until-perl: ${{ matrix.until-perl || null }}
          with-devel: ${{ matrix.with-devel || null }}
          single-out: ${{ matrix.single-out || null }}

      - name: Validate output - ${{ matrix.name }}
        uses: prompt/actions-assert@v4
        with:
          assertion: npm://@assertions/is-equal:v1
          actual:    ${{ steps.call-action.outputs.perl-versions }}
          expected:  ${{ matrix.expected }}

      - name: Validate single-out output - ${{ matrix.name }}
        if: matrix.expected-single-out
        uses: prompt/actions-assert@v4
        with:
          assertion: npm://@assertions/is-equal:v1
          actual:    ${{ steps.call-action.outputs.single-out }}
          expected:  ${{ matrix.expected-single-out }}
